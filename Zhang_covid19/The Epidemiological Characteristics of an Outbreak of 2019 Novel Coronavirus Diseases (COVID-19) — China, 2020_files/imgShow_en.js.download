$(document).ready(function () {
 
	$("#originalImgs-wrapper").css({"width":$(".article-main-mid").outerWidth()});
	function wh(index){
		var imgClass=$('#FullText div._figclass.figure .figure_title>a>img').eq(index).attr("class");
        $("#originalImgs").attr({"class":imgClass});
	}
	
 
    var imgArr = imgBox();
    var wrapper = $('#miniImgs-wrapper');
    var miniImgHeight = parseInt(wrapper.css('height'));
    
 
    var originalImgsObj = {};
    

 
    function openImg(imgIndex) {
 
    	var clickAble = true;
    	
        var miniImgs = $("#miniImgs");
 
        var miniImgsUl = miniImgs.children('ul');
 
        var miniImgsLi = miniImgsUl.children('li');
 
        var miniImgsLength = miniImgsLi.length;


 
        $('#allImgNum').html(miniImgsLength);


 
        var miniImgsLiHeight = miniImgsLi.eq(0).css('height');
 
        var liHeight = parseInt(miniImgsLiHeight) + 5;
 
        var index = 0;
 
        var num = 4;
 
        var num2 = Math.ceil(num / 2);
        
 
        var theOpenNum = 0;

        
 
        function change() {
            var originalImgs = $('#originalImgs');
            
            
//            $('#ruler .staff').css('left',-13);
            
            
 
            var val;
 
            if (index < num2) {
                val = Animate(miniImgsUl, {top: 0});
            } else if (index + num2 < miniImgsLength) {
                val = Animate(miniImgsUl, {top: -(index - num2 + 1) * liHeight});
            } else {
                val = Animate(miniImgsUl, {top: -(miniImgsLength - num) * liHeight});
            }


 
			var nowImg = imgArr[index];
            var src = nowImg.src;
            
 
            if(!originalImgsObj[src]){
 
                originalImgs.css('visibility','hidden');
                 
                var img = new Image();
                img.src = src;
                img.onload = function(e){
//                  e.stopPropagation();
                    originalImgs.attr('src', src);
                    originalImgsObj[src] = true;
                    originalImgs.css('visibility','visible');
                    wh(index);
                };
            }else{
 
                originalImgs.attr('src', src);
            }
 
            $('#nowImgIndex').html(index+1);
 
            $('#imgTitle .titleEn').html(nowImg.titleEn);
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            $('#originalImgDownload').attr('onclick',nowImg.downloadImg);
            $('#originalPPTDownload').attr('onclick',nowImg.downloadPPT);

 
            miniImgsLi.eq(index).addClass('borderHigh').siblings('.borderHigh').removeClass('borderHigh');
 
            if(theOpenNum!=0 && clickAble){
 
                clickAble = false;
                miniImgsUl.animate({top: val}, 150);
                setTimeout(function(){
                	clickAble = true;
                },150);
            }else{
 
                miniImgsUl.css('top',val);
 
                theOpenNum++;
            }
        }


 
        $(document).on('click', '#miniImgs a', function (e) {
            e.preventDefault();
            if(index === $(this).parent().index()){
                return;
            }
            index = $(this).parent().index();
            wh(index);
            change();
        });

 
        $('#imgPrev').click(imgPrev);
        $('#imgNext').click(imgNext);

        function imgPrev() {
            index--;
//            index = index == -1 ? miniImgsLength -1 : index;
            if (index === -1){
                index = 0;
                return;
            }
            wh(index);
            change();
        };
        function imgNext() {
            index++;
//            index = index == miniImgsLength ? 0 : index;
            if(index === miniImgsLength){
                index = miniImgsLength-1;
                return;
            }
            wh(index);
            change();
        };

 
        if (typeof imgIndex === 'number') {
            index = imgIndex;
        }else{
            index = 0;
        }

   
        $('#originalImgs-wrapper div.originalImgs-wrapper').mousemove(function(event){
            var _this = $(this);
            var y = event.pageY;

            var height = $(this).height();
            var marginTop = $(this).offset().top;

            if(y>=marginTop&&y<marginTop+height/2) {
                _this.removeClass('theNext').addClass('thePrev');
                return;
            }
            if(y>=marginTop+height/2 && y<marginTop+height){
                _this.addClass('theNext').removeClass('thePrev');
                return;
            }

            _this.removeClass('theNext').removeClass('thePrev');
        }).on('click',function(){
            if($(this).hasClass('theNext')){
                imgNext();
                return;
            }
            if($(this).hasClass('thePrev')){
                imgPrev();
                return;
            }

        });

 
        change();
    }

    
 



 
	$(document).on('click','.atlas img',function(){
		$('#imgShow').show();
		addHtmlPadding();
		openImg();
	});
 
	$(document).on('click','#FullText ._figclass .figure_title>a',function(e){
		e.preventDefault();
		var index = $(this).parents('._figclass').index('#FullText ._figclass');
//		alert(index);
		$('#imgShow').show();
		addHtmlPadding();
		openImg(index);
	});
 
	$(document).on('click','#figTab ._figclass .figureTextBox a',function(e){
		e.preventDefault();
		var index = $(this).parents('._figclass').index('#figTab ._figclass');
//		alert(index);
		$('#imgShow').show();
		addHtmlPadding();
		openImg(index);
	});
	
 
	$(document).on('click','#imgBack>a',function(e){
		e.preventDefault();
		clearHtmlPadding();
		$('#imgShow').hide();
	});

	
 
    function Animate(obj, json) {
        var iCur = parseInt(obj.css('top'));
        iCur = iCur ? iCur : 0;
        var iSpeed = (json.top - iCur);
        iSpeed = iSpeed > 0 ? Math.ceil(iSpeed) : Math.floor(iSpeed);
        return (iCur + iSpeed + 'px');
    }
	
 
    function getImgSize(img){
        var nWidth, nHeight;
        if(img.naturalWidth){
            nWidth = img.naturalWidth;
            nHeight = img.naturalHeight;
        }else{//IE 6 7 8
            var image = new Image();
            image.src = img.src;
            image.onload = function(){
                nHeight = image.style.height;
                nWidth = image.style.width;
            }
        }
        return {width:nWidth,height:nHeight};
    }
	 
	function imgBox(){
		var imgs = $('#miniImgs>ul>li');
		var titles = $('#miniImgs_title>li');
		MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
		var imgArr = [];
		
		for (var n=0;n<imgs.length;n++){
			var img = imgs.eq(n);
			var title = titles.eq(n);
			var imgSrc = img.find('a').attr('href');
			var imgDownloadImg = img.attr('data-img');
			var imgDownloadPPT = img.attr('data-ppt');
			var imgTitleEn = title.text();
			var miniSrc = img.find('a>img').attr('src');
			var imgObj = {
				src:imgSrc,
				downloadImg:imgDownloadImg,
				downloadPPT:imgDownloadPPT,
				titleEn:imgTitleEn,
				miniSrc:miniSrc
			};
			imgArr.push(imgObj);
		}
		return imgArr;
	}
});



