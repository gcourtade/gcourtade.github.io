$(function () {

	$(".alphtit").click(function(){
		$(".alphcon").toggle();
		$(".alphtit").toggleClass("rotate");
	})
	$(".columns-tit").click(function(){
		if($(this).siblings(".columns-detail").length > 0){
			$(this).siblings(".columns-detail").toggle();
			$(this).toggleClass("rotate");
		}
	})
	$(".columns-two").click(function(){
		if($(this).siblings(".columns-three").length > 0){
			$(this).parents(".columns-detail").show();
			$(this).parents(".columns-detail").siblings(".columns-tit").addClass("rotate")
			$(this).siblings(".columns-three").toggle();
			$(this).toggleClass("rotate");
		}
	})
	var pageId = $("#pageViewId").val();
	var _href=window.location.href;
	if (_href.indexOf("news_list") > 0)
	{
		pageId=getUrlParam("column");
	}
	
	if($(".columns-tit[data = "+pageId+"]").length > 0){
		$(".columns-tit[data = "+pageId+"]").trigger("click")
	}
	if($(".columns-two[data = "+pageId+"]").length > 0){
		$(".columns-two[data = "+pageId+"]").trigger("click");
		if($(this).siblings(".columns-three").length == 0){
			$(".columns-two[data = "+pageId+"]").parents(".columns-detail").siblings(".columns-tit").trigger("click")
			$(".columns-two[data = "+pageId+"]").parents(".columns-detail").css("display","block");
			$(".columns-two[data = "+pageId+"]").parents(".columns-detail").siblings(".columns-tit").addClass("rotate");
		}
		
		
	}
	if($(".columns-three[data = "+pageId+"]").length > 0){
		$(".columns-three[data = "+pageId+"]").siblings(".columns-two").trigger("click")
		//$(".columns-two[data = "+pageId+"]").parents(".columns-detail").siblings(".columns-tit").trigger("click")
	}
	//当文章列表无图时，重置宽度
	$(".article-list").each(function(i,e){
		if($(e).find(".listpic").length == 0 && $(window).width()>1170){
			$(e).find(".listwrap").css("max-width","100%");
		}
	});
	getCatalogPublishDate1();
	getCatalogPublishDate2();
	getCatalogPublishDate3();
	getCategoryYear();
	getCurrentCategoryLinks();
	getCurrentCategoryLinksCn();
	
	
	if($("#affiliations").length > 0){
		$(".affibtn").click(function(){
			var _h = $("#affiliations").offset().top;
			$("html,body").animate({scrollTop:_h - 95+"px"},500);
		})
	}
	
	if($("#about-articletit-app").length > 0){
		$(".affibtnPhone").click(function(){
			var _h = $("#about-articletit-app").offset().top;
			$("html,body").animate({scrollTop:_h - 0+"px"},500);
		})
	}
});

function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
    var r = window.location.search.substr(1).match(reg);  //匹配目标参数
    if (r != null) return encodeURI(r[2]); return null; //返回参数值
}
function getCatalogPublishDate1()
{
	var categoryName="Recommendations";
	var catagory1=$("#catagory1");
	var catagory3=$("#catagory3");
	if (catagory1 !=null ||  catagory3 !=null)
	{
		$.ajax({
			url: local_host +"zcustom/getCatalogPublishDate",
			data:{categoryName:categoryName},
			type:"post",
			dataType:"json",
			success:function(data){	
				if (data.publishDate!="")
				{
					if (catagory1 !=null)
					{
						catagory1.empty();
						//catagory1.html("<span></span>Recommendations ("+ DateFormat(new Date(data.publishDate),"MMMM dd, yyyy") +")")
						catagory1.html("<span></span>Recommendations");
					}
					if (catagory3 !=null)
					{
						catagory3.empty();
						catagory3.html("<span></span>建议和指南 ("+ DateFormat(new Date(data.publishDate),"yyyy年MM月dd日") +")")
					}
				}
			}
		})
	}
}

function getCatalogPublishDate2()
{
	var categoryName="Surveillance Summaries";
	var catagory2=$("#catagory2");
	var catagory4=$("#catagory4");
	if (catagory2 !=null || catagory4 !=null)
	{
		$.ajax({
			url: local_host +"zcustom/getCatalogPublishDate",
			data:{categoryName:categoryName},
			type:"post",
			dataType:"json",
			success:function(data){
				if (data.publishDate!="")
				{
					if(catagory2 !=null)
					{
						catagory2.empty();
						//catagory2.html("<span></span>Surveillance Summaries ("+ DateFormat(new Date(data.publishDate),"MMMM dd, yyyy") +")")
						catagory2.html("<span></span>Surveillance Summaries")
					}
					if(catagory4 !=null)
					{
						catagory4.empty();
						catagory4.html("<span></span>监测总结 ("+ DateFormat(new Date(data.publishDate),"yyyy年MM月dd日") +")")
					}
				}
			}
		})
	}
}
function getCatalogPublishDate3()
{
	var categoryName="Supplements";
	var catagory5=$("#catagory5");
	var catagory6=$("#catagory6");
	if (catagory5 !=null || catagory6 !=null)
	{
		$.ajax({
			url: local_host +"zcustom/getCatalogPublishDate",
			data:{categoryName:categoryName},
			type:"post",
			dataType:"json",
			success:function(data){
				if (data.publishDate!="")
				{
					if(catagory5 !=null)
					{
						catagory5.empty();
						//catagory5.html("<span></span>Supplements ("+ DateFormat(new Date(data.publishDate),"MMMM dd, yyyy") +")")
						catagory5.html("<span></span>Supplements")
					}
					if(catagory6 !=null)
					{
						catagory6.empty();
						catagory6.html("<span></span>监测总结 ("+ DateFormat(new Date(data.publishDate),"yyyy年MM月dd日") +")")
					}
				}
			}
		})
	}
}
function getCategoryYear()
{
	$.ajax({
		url:local_host+"zcustom/getCatalogYear",
		type:"post",
		dataType:"json",
		success:function(data){
	
		$("a:contains('Past Volumes1')").text("Past Volumes(" + data.yearone+")");
		$("a:contains('Past Volumes2')").text("Past Volumes(" + data.yeartwo+")");
		$("a:contains('Past Volumes3')").text("Past Volumes(" + data.yearthree+")");
		$("a:contains('Past Volumes4')").text("Past Volumes(" + data.yearfour+")");
		
		$("a:contains('过卷1')").text("过卷(" + data.yearone+")");
		$("a:contains('过卷2')").text("过卷(" + data.yeartwo+")");
		$("a:contains('过卷3')").text("过卷(" + data.yearthree+")");
		$("a:contains('过卷4')").text("过卷(" + data.yearfour+")");
		}
	})

}
function getCurrentCategoryLinks()
{
	$.ajax({
		url:local_host+"zcustom/getCurrentCategoryLinks",
		type:"post",
		dataType:"json",
		data:{pageType:"en"},
		success:function(data)
		{
			if (data.catalogVo1 !=null || data.catalogVo1 !="undefined" || data.catalogVo1 !=undefined)
			{
				
				$("a[data-category='Weekly Reports']").attr("href" ,local_host+data.pageType+"/zcustom/currentVolume/1");
			}	else
			{$("a[data-category='Weekly Reports']").attr("href" ,"");}
			if (data.catalogVo2 !=null || data.catalogVo2 !="undefined" || data.catalogVo2 !=undefined)
			{
				//$("a:contains('Recommendations and Reports')").attr("href" ,local_host+data.pageType+"/zcustom/getVolumeInfo?param=2&year="+data.catalogVo2.year+"&volume="+data.catalogVo2.volume);
				$("a[data-category='Recommendations']").attr("href" ,local_host+data.pageType+"/zcustom/currentVolume/2");
				
			}	else
			{$("a[data-category='Recommendations']").attr("href" ,"");}
			if (data.catalogVo3 !=null || data.catalogVo3 !="undefined" || data.catalogVo3 !=undefined)
			{
				//$("a:contains('Surveillance Summaries')").attr("href" ,local_host+data.pageType+"/zcustom/getVolumeInfo?param=3&year="+data.catalogVo3.year+"&volume="+data.catalogVo3.volume);
				$("a[data-category='Surveillance Summaries']").attr("href" ,local_host+data.pageType+"/zcustom/currentVolume/3");
			}	else
			{$("a[data-category='Surveillance Summaries']").attr("href" ,"");}
			
			if ( data.catalogVo4 !=undefined )
			{
				
				$("a[data-category='Supplements']").attr("href" ,local_host+data.pageType+"/zcustom/currentVolume/4");
			}
			else
			{$("a[data-category='Supplements']").attr("href" ,"");}
	 
	
		}
	})
}
function getCurrentCategoryLinksCn()
{
	$.ajax({
		url:local_host+"zcustom/getCurrentCategoryLinks",
		type:"post",
		dataType:"json",
		data:{pageType:"cn"},
		success:function(data)
		{
			if (data.catalogVo1 !=null || data.catalogVo1 !="undefined" || data.catalogVo1 !=undefined)
			{
				
				$("a[data-category='周报告']").attr("href" ,local_host+data.pageType+"/zcustom/volume/1/"+data.catalogVo1.year+"/"+data.catalogVo1.volume);
			}	else
			{$("a[data-category='周报告']").attr("href" ,"");}
			if (data.catalogVo2 !=null || data.catalogVo2 !="undefined" || data.catalogVo2 !=undefined)
			{
				//$("a:contains('Recommendations and Reports')").attr("href" ,local_host+data.pageType+"/zcustom/getVolumeInfo?param=2&year="+data.catalogVo2.year+"&volume="+data.catalogVo2.volume);
				$("a[data-category='建议和指南']").attr("href" ,local_host+data.pageType+"/zcustom/volume/2/"+data.catalogVo2.year+"/"+data.catalogVo2.volume);
				
			}	else
			{$("a[data-category='建议和指南']").attr("href" ,"");}
			if (data.catalogVo3 !=null || data.catalogVo3 !="undefined" || data.catalogVo3 !=undefined)
			{
				//$("a:contains('Surveillance Summaries')").attr("href" ,local_host+data.pageType+"/zcustom/getVolumeInfo?param=3&year="+data.catalogVo3.year+"&volume="+data.catalogVo3.volume);
				$("a[data-category='监测总结']").attr("href" ,local_host+data.pageType+"/zcustom/volume/3/"+data.catalogVo3.year+"/"+data.catalogVo3.volume);
			}	else
			{$("a[data-category='监测总结']").attr("href" ,"");}
			
			if ( data.catalogVo4 !=undefined )
			{
				
				$("a[data-category='增刊']").attr("href" ,local_host+data.pageType+"/zcustom/volume/4/"+data.catalogVo4.year+"/"+data.catalogVo4.volume);
			}
			else
			{$("a[data-category='增刊']").attr("href" ,"");}
	 
	
		}
	})
}
function subscribeClick()
{
	$("a:contains('Subscriptions')").parent().removeClass("rotate").addClass("rotate").siblings().css('display','block');
	
}

function DateFormat(now,mask)
{
    var d = now;
    var zeroize = function (value, length)
    {
        if (!length) length = 2;
        value = String(value);
        for (var i = 0, zeros = ''; i < (length - value.length); i++)
        {
            zeros += '0';
        }
        return zeros + value;
    };
 
    return mask.replace(/"[^"]*"|'[^']*'|\b(?:d{1,4}|MM(?:MM)?|yy(?:yy)?|([hHMstT])\1?|[lLZ])\b/g, function ($0)
    {
        switch ($0)
        {
            case 'd': return d.getDate();
            case 'dd': return zeroize(d.getDate());
            case 'ddd': return ['Sun', 'Mon', 'Tue', 'Wed', 'Thr', 'Fri', 'Sat'][d.getDay()];
            case 'dddd': return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][d.getDay()];
            case 'M': return d.getMonth() + 1;
            case 'MM': return zeroize(d.getMonth() + 1);
            case 'MMM': return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][d.getMonth()];
            case 'MMMM': return ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][d.getMonth()];
            case 'yy': return String(d.getFullYear()).substr(2);
            case 'yyyy': return d.getFullYear();
            case 'h': return d.getHours() % 12 || 12;
            case 'hh': return zeroize(d.getHours() % 12 || 12);
            case 'H': return d.getHours();
            case 'HH': return zeroize(d.getHours());
            case 'm': return d.getMinutes();
            case 'mm': return zeroize(d.getMinutes());
            case 's': return d.getSeconds();
            case 'ss': return zeroize(d.getSeconds());
            case 'l': return zeroize(d.getMilliseconds(), 3);
            case 'L': var m = d.getMilliseconds();
                if (m > 99) m = Math.round(m / 10);
                return zeroize(m);
            case 'tt': return d.getHours() < 12 ? 'am' : 'pm';
            case 'TT': return d.getHours() < 12 ? 'AM' : 'PM';
            case 'Z': return d.toUTCString().match(/[A-Z]+$/);
            // Return quoted strings with the surrounding quotes removed
            default: return $0.substr(1, $0.length - 2);
        }
    });
};

//下载pdf
function downloadIssuepdf(catalogId) {
	 var url = local_host + "zcustom/checkIssuePdf?id=" + catalogId;
	    $.ajax({
	        type: "post",
	        url: url,
	        dataType: "json",
	        success: function (data) {
	            if (data.access == false) {
	            	window.location.href = local_host + 'member/login';
	                //alert(data.message);
	            } else if (data.result == 'true') {

	                var url = local_host + "zcustom/exportPdf";
	                var form = $("<form>");    
	                form.attr('style', 'display:none');    
	                form.attr('target', '');
	                form.attr('method', 'post');
	                form.attr('action', url);

	                var input1 = $('<input>');
	                input1.attr('type', 'hidden');
	                input1.attr('name', 'id');
	                input1.attr('value', catalogId);
	                $('body').append(form);   
	                form.append(input1);    
	                form.submit();

	            } else if (data.result == 'false') {
	                var url = window.location.href;
	                var pageType = getUrlParam("pageType") || pageTypeDefault;
	                alert("PDF not found!")
	               
	            }
	        },
	        error: function () {
	            alert("Download error, please contact the administrator!");
	        }
	    });
}
$(function(){
	var idArray=[];
	$("#view li").each(function(i,e){
		var articleId=$(e).attr("articleid");
		if(!isNull(articleId))
		{
			idArray.push(articleId);
		}
	});
	$("#cited li").each(function(i,e){
		var articleId=$(e).attr("articleid");
		if(!isNull(articleId))
		{
			 if($.inArray(articleId,idArray) <0){				
				idArray.push(articleId);
				}
		}
	});
	$("#attention li").each(function(i,e){
		var articleId=$(e).attr("articleid");
		if(!isNull(articleId))
		{
			 if($.inArray(articleId,idArray) <0){		
				 idArray.push(articleId);
			 }
		}
	});
	if(idArray.length > 0)
	{
		var ids=idArray.toString();
		var ajaxArg={
				url: local_host +"article/getArticleMetric",
				data: {'articleIds':ids},
				returnFun:outArticleMetricccdcw
		};
		ajaxPost(ajaxArg);
	}
	
})

function outArticleMetricccdcw(data){
	if (typeof(data) !="undefined")
	{
		$.each(data,function(i,e){
			console.log(e.articleId);
			$("li[articleid='"+e.articleId+"']").find(".abs-num").html(e.viewCount);
			$("li[articleid='"+e.articleId+"']").find(".pdf-num").html(e.pdfDownCount);
		});
	}
}
$(function(){
	$(".columns-tit[data='publications']").siblings().css("display","block");
})

$(function(){
   var articleId=$("#articleId").val();
	if (articleId !=null && articleId !="")
	{
	$.ajax({
        type: "post",
        url: local_host +"zcustom/getHasFormula",
        data:{'articleId':articleId},
        dataType: "json",
        success: function (data) {
		if (data.count=="0")
		{
			$(".switchFormula").hide();
		}
	}
	})
	}
            	
})


$(function(){
	
	var ext_link=$("ext-link");	
	var footNote=$("#footNote").html();
	if (typeof(footNote) !="undefined" && footNote !="")
	{
		if (ext_link.length > 0)
		{
		 
		$.each(ext_link, function(i,e){
			var outerHTML=$(e).prop("outerHTML");
			var newLink="<a href=\"" +$(e).html() +"\" target=\"_blank\">" + $(e).html()+"</a>";
			var reg = new RegExp(outerHTML,"g"); 
			footNote=footNote.replace(reg,newLink);		 
		})
		$("#footNote").empty();
		$("#footNote").html(footNote);
		}
	}
})

$(function(){
	
	var ext_link=$("ext-link");	
	var footNote=$("#htmlContent2").html();
	if (typeof(footNote) !="undefined" && footNote !="")
	{
		if (ext_link.length > 0)
		{
		 
		$.each(ext_link, function(i,e){
			var outerHTML=$(e).prop("outerHTML");
			var newLink="<a href=\"" +$(e).html() +"\" target=\"_blank\">" + $(e).html()+"</a>";
			var reg = new RegExp(outerHTML,"g"); 
			footNote=footNote.replace(reg,newLink);		 
		})
		$("#htmlContent2").empty();
		$("#htmlContent2").html(footNote);
		}
	}
})