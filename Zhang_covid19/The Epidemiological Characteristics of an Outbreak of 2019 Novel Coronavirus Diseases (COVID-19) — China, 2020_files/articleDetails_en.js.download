var currentState = 0;	 
$(document).ready(function(){
    $("#navigation").mCustomScrollbar();
 
    $('title').text(function(){
        return ($(this).text().replace(/\$[^\$]*\$/g,"").replace(/<[^>]+>/g,""));
    });
 
    var fullTextId = $('#articleId').val();

 
    currentAllTextHtml(getFullText);
    resetFormulaSrc();

 
    var tab = $('#myTab');

    var clickAble = true;

//	$('#myTab a').on('click',function(){
//		if($(this).attr('id')==='htmlview'){
//			$('#article-navigation').removeClass('hidden');
//			ajaxCountHtmlView(fullTextId, getFullText);
//			return;
//		}
//		$('#article-navigation').addClass('hidden');
//	});
    //ajaxCountHtmlView(fullTextId, getFullText);
    function articleH(){
        $(".article-main-left,.article-main-right").css({"height":$(window).height()-$(".article-header-new").height()});
        // if($(window).height() < $(".article-right").height()){
        // $(".article-right-pic").hide()
        // }else $(".article-right-pic").show()
    }
    $(window).load(function(){
        articleH();
    });
    $(window).resize(function(){
        articleH()
    });

    $(document).scroll(shareScroll);



    $('.box').mouseenter(addHtmlPadding);
    $('.box').mouseleave(clearHtmlPadding);
    $(window).resize(function(){
        var AllHeight = $(document).height();
        var nowScroll = $(window).scrollTop()+$(window).height();
        var footerHei = $('#common-bottom').height();
        var nav = $('.article-navigation.fix');


        var navHeight = $('.article-navigation.fix ul').height();

        var navWrapperHeight = $('.article-navigation.fix').height();
        if(navHeight>navWrapperHeight){
            nav.find('.strap').addClass('show');
            $('.article-navigation .strap>div').css('height',navWrapperHeight/navHeight*100+'%');
        }else{
            nav.find('.strap').removeClass('show');
        }
        if(AllHeight - nowScroll < footerHei){
            nav.css('padding-bottom',30+footerHei+nowScroll-AllHeight);
            return;
        }
        if(AllHeight - nowScroll >= footerHei){
            nav.css('padding-bottom',30);
            return;
        }
    });


    function getFullText(){
   
        $(".Abstract-left-list a").html($("#Abstract-list").text());
        $(".Abstract-left-list a").attr({"href":'#'+$("#Abstract-list").attr("id")});
  
        var arr = $('.article-main-mid .navTitle2');
        var _topCatalogEles = [];
        var _curTopCatalogEle = null;
        var _curSecondEle = null;
        var _FigureOrTable =new Boolean();
        var _FigureOrTableHtml="";
        for (var i=0;i<arr.length;i++){
            var _text = $('.article-main-mid .navTitle2').eq(i).text().trim();
            _FigureOrTable=false;
            if (_text.startWith("Figure"))
            {
            	_text=_text.substring(0,9).replace(".","");
            	_FigureOrTable=true;
            	//arr.eq(i).hide();
            	//arr.eq(i).empty();
            }
            
            if (_text.startWith("Table"))
            {
            	_text=_text.substring(0,8).replace(".","");
            	_FigureOrTable=true;
            	//arr.eq(i).hide();
            	//arr.eq(i).empty();
            }
            var arr2=$('.article-main-mid .navTitle2').eq(i).find("span").attr("id");
            var _curLevel = $('.article-main-mid .navTitle2').eq(i).find("span").attr("level");
            var _curNodEle = $('<div class="div'+ _curLevel +' textHidden"><a href=#'+arr2+'>'+_text+'</a></div>');
            if (_FigureOrTable==false)
            {
	            if("1" == _curLevel){
	                _curTopCatalogEle = _curNodEle;
	                _topCatalogEles.push(_curTopCatalogEle);
	            }else if("2" == _curLevel){
	                _curSecondEle = _curNodEle;
	                if (_curTopCatalogEle !=null){
	                _curTopCatalogEle.append(_curSecondEle);
	                }
	            }else if("3" == _curLevel){
	                _curSecondEle.append(_curNodEle);
	            }
            }else
            {
            	_FigureOrTableHtml+=_curNodEle.prop("outerHTML");
            }
            
        }
        $('.jumplink-list').append(_topCatalogEles);
        $('.FigureOrTable').empty().append(_FigureOrTableHtml);
        
        
        $(".References-left-list a").html($("#References-list").text());
        $(".References-left-list a").attr({"href":'#'+$("#References-list").attr("id")});

        // Supplements
        $(".Supplements-left-list a").html($("#Supplements-list").text());
        $(".Supplements-left-list a").attr({"href":'#'+$("#Supplements-list").attr("id")});
        
        
        _FigureOrTableHtml=""
        var _figSpan= $("#figTab .FigText");
        $.each(_figSpan,function(i,e){
        	//console.log($(e).children().get(0).attr("id"));
        	//console.log($(e).attr("id"));
            var _curNodEle = $('<div class="div1 textHidden"><a href=#>'+$(e).attr("id").toUpperCase()+'</a></div>');
            _FigureOrTableHtml+=_curNodEle.prop("outerHTML");
        });
        var _tableSpan= $("#figTab .TableText");
        $.each(_tableSpan,function(i,e){
        	//console.log($(e).children().get(0).attr("id"));
        	//console.log($(e).attr("id"));
        	 var _curNodEle = $('<div class="div1 textHidden"><a href=#>'+$(e).attr("id").toUpperCase()+'</a></div>');
             _FigureOrTableHtml+=_curNodEle.prop("outerHTML");
        });
        $('.FigureOrTable').empty().append(_FigureOrTableHtml);
        

    }
    getFullText();


    function right(){
        var navH=$(".header-nav").height();
        if($(".header-nav").length>0){
            var navT=$(".header-nav").offset().top;

        }
        if($(window).scrollTop()>=navT){
            $(".article-header-new").addClass("active");
            $(".article-main .inner").addClass("active");
            $(".article-main-left").addClass("active");
            $(".article-main-mid").addClass("active");
            $(".article-main-right").addClass("active");
            $(".article-main-right").css({"right":($(window).width()-$(".inner").width())/2});
        }else{
            $(".article-header-new").removeClass("active");
            $(".article-main .inner").removeClass("active");
            $(".article-main-left").removeClass("active");
            $(".article-main-mid").removeClass("active");
            $(".article-main-right").removeClass("active");
            $(".article-main-right").css({"right":"auto"});
        }
    }
    right();
    $(window).load(function(){
        right();
    });
    $(window).resize(function(){
        right();
    })
    function scrollEn(){
        var windowTop=$(window).scrollTop();
      
        if($("#Abstract-list").length>0){
            var AbstractTop=$("#Abstract-list").offset().top-56;
            if(AbstractTop<=windowTop){
                $(".Abstract-left-list").addClass("active");
            }else {
                $(".Abstract-left-list").removeClass("active");
            }
        }

   
        var titleEn=$('.article-main-mid h3.navTitle2');
        var titleEn2=$('.article-main-mid h4.navTitle2');
        var titleEn3=$('.article-main-mid h5.navTitle2');

        var arrScroll = $('.article-main-mid .navTitle2');
        for(var i=0;i<arrScroll.length;i++){
            if(arrScroll.eq(i).length>0){
                var top=arrScroll.eq(i).offset().top-50;
            }
            if(arrScroll.eq(i).offset().top-60<=windowTop){
                if(arrScroll.get(i).tagName=="H3"){
                    $(".jumplink-list div").eq(i).addClass("active").siblings(".div1").removeClass("active");
                    $(".jumplink-list div").eq(i).find(".div2").show();
                    $(".jumplink-list div").eq(i).siblings(".div1").find(".div2").hide();
                    $(".Abstract-left-list").removeClass("active");
                }
                if(arrScroll.get(i).tagName=="H4"){
                    $(".jumplink-list div").eq(i).find(".div3").show();
                    $(".jumplink-list div").eq(i).siblings(".div2").find(".div3").hide();
                    $(".jumplink-list div").eq(i).addClass("active2").siblings(".div2").removeClass("active2");
                }
                if(arrScroll.get(i).tagName=="H5"){
                    $(".jumplink-list div").eq(i).addClass("active2").siblings(".div3").removeClass("active2");
                }
            }else{
                if(arrScroll.get(i).tagName=="H3"){
                    $(".jumplink-list div").eq(i).removeClass("active");
                    $(".jumplink-list div").eq(i).find(".div2").hide();
                }
            }
        }
         
        if($("#References-list").length>0){
            var ReferencesTop=$("#References-list").offset().top-60;
            if(ReferencesTop<=windowTop){
                $(".References-left-list").addClass("active");
                $(".Abstract-left-list").removeClass("active");
                $(".jumplink-list .div1").removeClass("active");
                $(".jumplink-list .div2").hide();
                $(".jumplink-list .div2").removeClass("active2");
            }else {
                $(".References-left-list").removeClass("active");
            }
        }

        // Supplements
        if($("#Supplements-list").length>0){
            var SupplementsTop=$("#Supplements-list").offset().top-60;
            if(SupplementsTop<=windowTop){
                $(".Supplements-left-list").addClass("active");
                $(".Abstract-left-list").removeClass("active");
                $(".jumplink-list .div1").removeClass("active");
                $(".jumplink-list .div2").hide();
                $(".jumplink-list .div2").removeClass("active2");
            }else {
                $(".References-left-list").removeClass("active");
            }
        }

        // Supplements
        if($("#Supplements-list").length>0){
            var SupplementsTop=$("#Supplements-list").offset().top-60;
            if(SupplementsTop<=windowTop){
                $(".Supplements-left-list").addClass("active");
                $(".Abstract-left-list").removeClass("active");
                $(".jumplink-list .div1").removeClass("active");
                $(".jumplink-list .div2").hide();
                $(".jumplink-list .div2").removeClass("active2");
            }else {
                $(".References-left-list").removeClass("active");
            }
        }
   
        if($("#Access-list").length>0){
            var AccessTop=$("#Access-list").offset().top-60;
            if(AccessTop<=windowTop){
                $(".References-left-list").removeClass("active");
            }
        }
    }
    scrollEn();
    $(window).scroll(function(){
        right();
        scrollEn();
    });
  
    $(".content-nav a,.Access-right-list a,.trend-right-list a,.FigureOrTable a").attr({"href":"javascript:;"});
    $(".content-nav a,.Access-right-list a,.FigureOrTable a").click(function(){
        var text=$(this).text().replace(/\s+/g, "");
        var midTit=$(".article-main-mid .navTitle");
       
        if (text.startWith("FIGURE"))
        {
        	midTit=$("#figTab .figure");
        }
        if (text.startWith("TABLE"))
        {
        	midTit=$("#figTab .table");
        }
        for(var i=0;i<midTit.length;i++){
            var text2=midTit.eq(i).text().replace(/\s+/g, "");
            if (text.startWith("FIGURE"))
            {
            	text2=text2.substring(0,8).replace(".","");
            }
            if (text.startWith("TABLE"))
            {
            	text2=text2.substring(0,7).replace(".","");
            }
            if(text2==text){
                $("html,body").animate({scrollTop:midTit.eq(i).offset().top-56},300);
                break;
            }
        }
    });
});



 
function shareScroll(){
    $("#navigation").mCustomScrollbar("update");
 
    fixed('#myTab','.article-share ul');
 
    fixed('.article-metrics','#article-navigation');

    var AllHeight = $(document).height();
    var nowScroll = $(window).scrollTop()+$(window).height();
    var footerHei = $('#common-bottom').height();
    var nav = $('.article-navigation.fix');

 
    var navHeight = $('.article-navigation.fix ul').height();
 
    var navWrapperHeight = $('.article-navigation.fix').height();
    if(navHeight>navWrapperHeight){
        nav.find('.strap').addClass('show');
        $('.article-navigation .strap>div').css('height',navWrapperHeight/navHeight*100+'%');
    }else{
        nav.find('.strap').removeClass('show');
    }
    if(AllHeight - nowScroll < footerHei){
        nav.css('padding-bottom',30+footerHei+nowScroll-AllHeight);
        return;
    }
    if(AllHeight - nowScroll >= footerHei){
        nav.css('padding-bottom',30);
        return;
    }
}
 
function fixed(standardName,objName){
    var scrollTop = $(document).scrollTop();
    if($(standardName).length>0){
        var standard = $(standardName),
            top = standard.offset().top + standard.height(),
            obj = $(objName);
    }
    if(top<scrollTop){
        if(!obj.hasClass('fix'))obj.addClass('fix');
        return;
    }
    //obj.removeClass('fix');
}

 
//function ajaxCountHtmlView(articleId,callback) {
//    if (currentState != 0) {
//        return;
//    }
//    $.ajax({
//        type: 'post',
//        url: local_host + 'article/htmlViewCountAjax',
//        data: {'articleId': articleId}
//    });
//    currentState = 1;
 
//    var contentHtml = cacheObj.get('FullText', articleId) || $.ajax({
//            url: local_host + 'article/htmlContent',
//            type: 'post',
//            async: false,
//            dataType: 'json',
//            data: {'id': articleId,'pageType':'en'},
//            success: function (data) {
//                if (data.access == false) {
//                    window.location.href = local_host + 'member/login';
//                    //alert(data.message);
//                } else {
//                    //var html = '<h3 class="navTitle"><span class="sec-title">References</span></h3>'+$('#References').html();
//                    if($('#reference:checked').length>0){
//                        data.htmlContent && $('#FullText').html(data.htmlContent);
//                    }else{
//                        data.htmlContent && $('#FullText').html(data.htmlContent);
//                    }
//                    cacheObj.set('FullText', articleId, true);
//                    callback();
//                }
//                //渲染数学公式
//                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
//                //重置全文中的公式是图片的路径
//                resetFormulaSrc();
//                if($(".table-body table").length>0){
//                    nbsp($(".table-body table"));
//                }
//                //createTableSub();
//                removeTableBorder();
//                setTableImg();
//            }
//        });
//    $(".group4").colorbox({rel:'group4',width:'90%',height:"75%",opacity:'0.8',inline:true, onComplete:function(){
//        removeTableBorder();
//        $("#cboxTitle").niceScroll({
//            cursorcolor:"transparent",
//            cursoropacitymax:1,
//            touchbehavior:false,
//            cursorwidth:"5px",
//            cursorborder:"0",
//            cursorborderradius:"5px"
//        });
//        //渲染数学公式
//        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
//    }
//    });
//    //getVisitInfo(articleId,3);
//}

/**
 * 如果viewType=="HTML",默认当前显示全文内容
 * @return
 */
function currentAllTextHtml(callback){
//	var viewType = getUrlParam("viewType");
//	if(viewType && "HTML" == viewType){
    // 获取全文数据
    var articleId =  $("#articleId").val();
    $('#htmlview').click();
    currentState++;
    $.ajax({
        url: local_host + 'article/htmlContent',
        type: 'post',
        dataType: 'json',
        async:false,
        data: {'id':articleId,'pageType':'en'},
        success: function (data) {
            if (data.access == false) {
                window.location.href = local_host + 'member/login';
                //alert(data.message);
            } else {
                $('#FullText').html(data.htmlContent);
                $('#article-navigation').removeClass('hidden');
                loadArticleMetricCount(articleId)

                $(".group4").colorbox({rel:'group4',width:'90%',height:"75%",opacity:'0.8',inline:true, onComplete:function(){
                    removeTableBorder();
                    $("#cboxTitle").niceScroll({
                        cursorcolor:"transparent",
                        cursoropacitymax:1,
                        touchbehavior:false,
                        cursorwidth:"5px",
                        cursorborder:"0",
                        cursorborderradius:"5px"
                    });
                    //渲染数学公式
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                }
                });
            }
            //渲染数学公式
            //MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            //重置全文中的公式是图片的路径
            resetFormulaSrc();
            resetAuthorSrc();
            if($(".table-body table").length>0){
                nbsp($(".table-body table"));
            }
            //createTableSub();
            removeTableBorder();
            setTableImg();
            replaceEXTLink();
        }
    })
//	}else{
//		$('#abstractview').click();
//	}
}
function replaceEXTLink()
{
	var ext_link=$("ext-link");	
	var fulltext=$("#FullText").html();
	if (typeof(fulltext) !="undefined" && fulltext !="")
	{
		if (ext_link.length > 0)
		{
		 
		$.each(ext_link, function(i,e){
			var outerHTML=$(e).prop("outerHTML");
			var _href=$(e).attr("xlink:href");	
			var newLink="<a href=\"" +_href +"\" target=\"_blank\">" + $(e).html()+"</a>";
			var reg = new RegExp(outerHTML,"g"); 
			fulltext=fulltext.replace(reg,newLink);		 
		})
		$("#FullText").empty();
		$("#FullText").html(fulltext);
		}
	}	
}
function resetAuthorSrc()
{
	 var path = $("#basePath").val();
	 var _image=$("img[src*='zuozhe']");
	 var imageSrc="";
	 $.each(_image,function(i,e){
		 var src=$(e).attr("src");
		 var arr=src.split('/');
		 if (arr.length==1)
		 {imageSrc=path + src;
		 }else if(arr.length ==2){
			 imageSrc=path +arr[1];
		 }else{imageSrc=src;}
		 $(e).attr("src",imageSrc);
	 })
}

//点击数字显示参考文献
//	$(document).delegate('#FullText sup','click',function(event){
//		event.preventDefault();
//		var _this = $(this);
//		if($(this).find("span.xref").length>0){
//			var supText = $(this).text(); //输出格式为[2,10,13-15]
//			var refIndexs = getRefSupIndex(supText); //输出数组(2,10,13,14,15)
//			var refIndexsLength=refIndexs.length; //获取数组个数
//			var father = $('.box .box-content');
//			$('.box .box-content').html('');
//			var html = '';
//
//			for(var i = 0;i<refIndexsLength;i++){
//				var supLiterNum=refIndexs[i];  //获取参考文献中的编号
//				var journalTitle = $('#References table tr').eq(supLiterNum-1).children('.td2').find('.journal').text();
//				var supLiter=$('#References table tr').eq(supLiterNum-1).children('.td2').text(); //获取参考文献中的内容
//				var doi = $('#References table tr').eq(supLiterNum-1).find('.doi').children('a').text();
//				var title = $('#References table tr').eq(supLiterNum-1).find('.title').text();
////				console.log(supLiterNum,supLiter);
//				var crossref = '<a href="http://dx.doi.org/'+doi+'" target="_bank">CrossRef<i class="articleFont icon-fenxiang"></i></a>';
//				if (!doi){
//					crossref='';
//				}
//				var ref = '';
//				if(!isNull(title)){
//					ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+title+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
//				}else if(!isNull(journalTitle)){
//					ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+journalTitle+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
//				}
//				html += '<tr><td class="" valign="top" style="padding-left:10px;">'+supLiterNum+'</td><td class="td2" style="padding-right:50px;">'+supLiter+ref+'</td></tr>';
//			}
//			$('.box .box-content').html(html);
//			show($('.box'),_this);
//		}
//	});



//	作者点击弹框
$(document).on('click','.article-author li>a',function(event){
    event.preventDefault();
    var _this = $(this),name = _this.html().replace(/(^\s*)|(\s*$)/g, ""),borther = _this.siblings('sup.authorTag');
    var box = $('.author-box');
    var about = _this.parents('.article-left').siblings('.about-author');
    var boxChild = box.children('.author-content');
    var num = borther.find('.com-num'),lists='',
        user = borther.find('.com-user'),
        emil = borther.find('.com-mail');
    var numarr = num.attr('data-tagval');
    var authorAddress = about.children('.article-author-address');
    if(authorAddress.length>1){
        if(numarr==="*"){
            for (var i=0;i<authorAddress.length;i++){
                lists+=authorAddress.eq(i).prop('outerHTML');
            }
        }else{
            numarr = num.attr('data-tagval').split(',');
            for (var i=0;i<numarr.length;i++){
                if(numarr[i]!=undefined && numarr[i] !="§"){
                    lists+=authorAddress.eq(numarr[i]-1).prop('outerHTML');
                }
            }
        }
    }else{
        lists+=authorAddress.eq(0).prop('outerHTML');
    }
    if (lists==null || typeof (lists)=="undefined" || lists=="undefined" )
    {
    	lists="";
    }
//		判断作者地址问题
    if(user.length==1 ){
        user='<h6><b>Corresponding author:</b>'+_this.html()+',&nbsp;<a href="mailto:'+_this.attr('data-relate')+'">'+_this.attr('data-relate')+'</a></h6>';
    }else if(_this.attr('data-relate')!=''){
        user='<h6>'+_this.html()+',&ensp;<a href="mailto:'+_this.attr('data-relate')+'">'+_this.attr('data-relate')+'</a></h6>';
    }else{
        user='<h6>'+_this.html()+'</h6>';
    }
    var html = user+'<ul>'+lists+'</ul>'+'<p></p>'+
        '<ol>'+
        //本地需要加/qjny
        //'<li><a href="/qjny/search?q='+name+'" target="_blank">本站搜索</a></li>'+
        //服务器不需要

        '<li><a href="javascript:void(0);" onclick="searchLike(\'authorNameEn\',\''+name+'\');">On this Site</a></li>'+
        '<li><a href="http://scholar.google.com/scholar?btnG=&hl=en&as_sdt=0%2C23&q=author:'+name+'" target="_blank">On Google Scholar</a></li>'+
        '<li><a href="http://www.ncbi.nlm.nih.gov/pubmed/?term='+name+'[Author]" target="_blank">On PubMed</a></li>'+
        '</ol>';
    boxChild.html(html);

    show(box,_this);
})


//	点击作者和参考文献弹框中的X，关闭弹框
$(document).on('click','.close-box',function(){
    $(this).parent().hide();
    clearHtmlPadding();
});
/*弹出层显示，处理因overflow：hidden引起的宽度变化*/
function addHtmlPadding(){
    var html = $('html'),oldWid = html.width();
    //html.addClass('over-hidden');
    var newWid = html.width();
    html.css('padding-right',newWid-oldWid);
//	$('.article-header').css('padding-right',newWid-oldWid);
    $('.bottom-fixed').css('right',function(){
        return (parseInt($(this).css('right'))+newWid-oldWid);
    });
//	$('.shareBox').css('right',newWid-oldWid);
}

/*弹出层隐藏，恢复原样*/
function clearHtmlPadding(){
    var html = $('html'),oldWid = html.width();
    //html.removeClass('over-hidden');
    var newWid = html.width();
    html.css('padding-right',0);
//	$('.article-header').css('padding-right',0);
    $('.bottom-fixed').css('right',function(){
        return (parseInt($(this).css('right'))+newWid-oldWid);
    });
//	$('.shareBox').css('right',0);
}
$(function(){
    $(".ijac-tab-ul li:last").css({"border":"none"});
    $(".ijac-tab-ul li").each(function(i){
        $(this).click(function(){
            $(this).addClass("ac").siblings().removeClass("ac");
            $(".ijac-tab>ol").eq(i).show().siblings().hide();
        })
    });
    $("#FullText p").each(function(){
        var reId=$(this).find("span.xref a").attr("href");
        //console.log(reId);
        //$("body,html").animate({scrollTop:$(reId).offset().top-60});
    })
});
//		浮框
function show(obj,sup) {
    var supWidth = sup.width();
    if($('.inner.content').length>0){
        var supTop = sup.offset().top-$('.inner.content').offset().top+2; //距离顶部的距离
    }
    var supOffsetLeft=parseInt(sup.position().left);
    var objleftArrow=supOffsetLeft;
    if(sup.parents(".article-author").length>0){    //弹出作者的
        var supFatherW=sup.parent("li").outerWidth(true);
        if(objleftArrow+supFatherW>$(".author-box").outerWidth(true)){
            var paddingL=parseInt($(".article-main-mid").css("padding-left"));
            var boxL=supOffsetLeft+paddingL+supWidth-$(".author-box").outerWidth(true);
            var objleftArrow2=supFatherW/2+22;
            obj.css({'top':supTop+'px','left': boxL+'px'}).show();
            obj.find('.triangle').css({'left':'auto','right':objleftArrow2+'px'});
        }else{
            obj.css({'top':supTop+'px','left': 0+'px'}).show();
            obj.find('.triangle').css('left',objleftArrow-16+supWidth/2+'px');
        }
    }else{      //弹出参考文献的
        // 设定浮框的left值，默认向左偏移200像素
        var triangleLeft = 200;
        //var objleft2 = sup.position().left;
        if($(sup).parent("sup").length>0){
            var supFatherWidth=$(sup).parent("sup").outerWidth(true);
            var canL=parseInt($(sup).parent("sup").position().left);
            var boxTanW=$(".box-tan").outerWidth(true);
            var canL2=canL+$(sup).width()/2;
            var pcPadingL=parseInt($(".article-main-mid").css("padding-left"));
            if(canL+(pcPadingL*3)<boxTanW){
                obj.css({'top':supTop+'px','left': 0+'px'}).show();
                obj.find('.triangle').css('left',canL-16+supFatherWidth/2+'px');
            }else{
                var canL=$(sup).parent("sup").position().left;
                obj.css({'top':supTop+'px','left': canL/2+'px'}).show();
                obj.find('.triangle').css('left',canL/2-16+supFatherWidth/2+'px');
            }
        }else{
            var canL=parseInt($(sup).position().left);
            var boxTanW=$(".box-tan").outerWidth(true);
            var canL2=canL+supWidth/2;
            var pcPadingL=parseInt($(".article-main-mid").css("padding-left"));
            if(canL+pcPadingL*2<boxTanW){
                obj.css({'top':supTop+'px','left': 0+'px'}).show();
                obj.find('.triangle').css('left',canL-16+supWidth/2+'px');
            }else{
                var canL=$(sup).position().left;
                obj.css({'top':supTop+'px','left': canL/2+'px'}).show();
                obj.find('.triangle').css('left',canL-16+supWidth/2-3+'px');
            }
        }
    }

}
//手机的
function show2(obj,sup) {
    var supWidth = sup.width();
    if($('.article-app #htmlContent2').length>0){
        var supTop2 = sup.offset().top-$('.article-app #htmlContent2').offset().top+2; //手机上距离顶部的距离
    }
    if($(sup).parent("sup").length>0){
        var supFatherWidth=$(sup).parent("sup").outerWidth(true);
        var canL=$(sup).parent("sup").position().left;
        var boxTanW=$(".box-tan").outerWidth(true);
        obj.css({'top':supTop2+25 +'px','left': 0+'px'}).show();
        obj.children('.triangle').css('left',canL-16+supFatherWidth/2+'px');
    }else{
        obj.css({'top':supTop2+25 +'px','left': 0+'px'}).show();
        obj.children('.triangle').css('left',canL-16+supWidth+'px');
    }
}
$(function(){
	// 弹出的表格
    function tableNew(){
        var tab="";
        var small="";
        var _this=$("#FullText .table_new");
        for(var i=0;i<_this.length;i++){
            var tabHtml=_this.eq(i).show().prop("outerHTML");
            _this.eq(i).hide()
            var smallTba=_this.eq(i).find(".table-body").prop("outerHTML");
            tab+='<li>'+tabHtml+'</li>';
            small+='<li><a href="javascript:;">'+smallTba+'</a></li>';
        }
        $(".show-table .piclist").append(tab);
        $("#picsmall").append(small);
        $(".show-table .piclist").css({"height":$(window).height()});
        $(".show-table .piclist li").css({"height":$(window).height()});
    }
    tableNew();

    //作者出版年序，把a href换成javascript:;要不就跳锚点了
    $(".FullText-all span.xref").each(function(){
        var xrefLen= $(".FullText-all span.xref");
        for(var i=0;i<xrefLen.length;i++){
            var href=xrefLen.eq(i).find("a").attr("href");
            xrefLen.eq(i).find("a").attr({"data-href":href});
        }
    });
    
     $("#Abstract span.xref a").attr({"href":"javascript:;"});
     $("#Abstract span.xref").each(function(){		//pc的
         var text='';
         $(this).click(function(event){
             event.preventDefault();
             if($(this).parent("sup").length>0){
                 var supText = $(this).parent("sup").text(); //输出格式为[2,10,13-15]
                 var refIndexs = getRefSupIndex(supText); //输出数组(2,10,13,14,15)
                 var reftype = $(this).find("a").attr("ref-type");
                 console.log($(this).html());
                
                 if (reftype=="fn")
                 {
                 	 var reg=new RegExp("[^0-9]","g");
                 	 var datahref=$(this).find("a").attr("data-href").replace(reg,"");
                 	 if (typeof(datahref) !="undefined" && datahref!=null)
                 	 {
                 		 refIndexs=datahref;
                 	 }
                 	 
                 }
     
                 var refIndexsLength=refIndexs.length; //获取数组个数
                 var father = $('.article-pc .box-tan .box-content');
                 $('.article-pc .box-tan .box-content').html('');
                 var html = '';
                 if (reftype=="fn")
                 {
                 	 for(var i = 0;i<refIndexsLength;i++){
  	                    var supLiterNum=refIndexs[i];  //获取参考文献中的编号
  	                    //var journalTitle = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').find('.journal').text();
  	                    var supLiter=$('#footNote .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').prop('outerHTML'); //获取参考文献中的内容
  	                    supLiterNum = $("#pn"+supLiterNum).find(".td1").text().trim();
  	                   
  	                    html += '<tr><td class="td1" valign="top">'+supLiterNum+'</td>'+supLiter+'</tr>';
  	                }
                 }
                 else{
 	                for(var i = 0;i<refIndexsLength;i++){
 	                    var supLiterNum=refIndexs[i];  //获取参考文献中的编号
 	                    var journalTitle = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').find('.journal').text();
 	                    var supLiter=$('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').prop('outerHTML'); //获取参考文献中的内容
 	                    var doi = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).find('.doi').children('a').text();
 	                    var title = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).find('.title').text();
 	                    //				console.log(supLiterNum,supLiter);
 	                    var crossref = '<a href="http://dx.doi.org/'+doi+'" target="_bank">CrossRef<i class="articleFont icon-fenxiang"></i></a>';
 	                    if (!doi){
 	                        crossref='';
 	                    }
 	                    var ref = '';
 	                    if(!isNull(title)){
 	                        ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+title+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
 	                    }else if(!isNull(journalTitle)){
 	                        ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+journalTitle+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
 	                    }
 	                    html += '<tr><td class="td1" valign="top">'+supLiterNum+'</td>'+supLiter+ref+'</tr>';
 	                }
                 }

                 $('.article-pc .box-tan .box-content').html(html);
                 show($('.article-pc .box-tan'),$(this));
             }else{
                 var _this = $(this);
                 var olLen=$("#References .References-wrap .reference-tab tr");
                 for(var i=0;i<olLen.length;i++){
                     var dataHref=$(this).find("a").attr("data-href").substring(1);
                     if(olLen.eq(i).attr("id")==dataHref){
                         var olSpan=olLen.eq(i).find(".td1").text();
                         var olText=olLen.eq(i).find(".td2").prop('outerHTML');
                         text = '<table><tr><td class="td1" valign="top">'+olSpan+'</td>'+olText+'</tr></table>';
                     }
                 }
                 if(text!=""){
                     $('.article-pc .box-tan .box-content').html(text);
                     show($('.article-pc .box-tan'),_this);
                 }
             }

         })
     })
    	 
    	 
    $(".FullText-all span.xref a").attr({"href":"javascript:;"});
    $(".article-pc .FullText-all span.xref").each(function(){		//pc的
        var text='';
        $(this).click(function(event){
            event.preventDefault();
            if($(this).parent("sup").length>0){
                var supText = $(this).parent("sup").text(); //输出格式为[2,10,13-15]
                var refIndexs = getRefSupIndex(supText); //输出数组(2,10,13,14,15)
                var reftype = $(this).find("a").attr("ref-type");
                console.log($(this).html());
               
                if (reftype=="fn")
                {
                	 var reg=new RegExp("[^0-9]","g");
                	 var datahref=$(this).find("a").attr("data-href").replace(reg,"");
                	 if (typeof(datahref) !="undefined" && datahref!=null)
                	 {
                		 refIndexs=datahref;
                	 }
                	 
                }
    
                var refIndexsLength=refIndexs.length; //获取数组个数
                var father = $('.article-pc .box-tan .box-content');
                $('.article-pc .box-tan .box-content').html('');
                var html = '';
                if (reftype=="fn")
                {
                	 for(var i = 0;i<refIndexsLength;i++){
 	                    var supLiterNum=refIndexs[i];  //获取参考文献中的编号
 	                    //var journalTitle = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').find('.journal').text();
 	                    var supLiter=$('#footNote .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').prop('outerHTML'); //获取参考文献中的内容
 	                    supLiterNum = $("#pn"+supLiterNum).find(".td1").text().trim();
 	                   
 	                    html += '<tr><td class="td1" valign="top">'+supLiterNum+'</td>'+supLiter+'</tr>';
 	                }
                }
                else{
	                for(var i = 0;i<refIndexsLength;i++){
	                    var supLiterNum=refIndexs[i];  //获取参考文献中的编号
	                    var journalTitle = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').find('.journal').text();
	                    var supLiter=$('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).children('.td2').prop('outerHTML'); //获取参考文献中的内容
	                    var doi = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).find('.doi').children('a').text();
	                    var title = $('#References .References-wrap .reference-tab tr').eq(supLiterNum-1).find('.title').text();
	                    //				console.log(supLiterNum,supLiter);
	                    var crossref = '<a href="http://dx.doi.org/'+doi+'" target="_bank">CrossRef<i class="articleFont icon-fenxiang"></i></a>';
	                    if (!doi){
	                        crossref='';
	                    }
	                    var ref = '';
	                    if(!isNull(title)){
	                        ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+title+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
	                    }else if(!isNull(journalTitle)){
	                        ref = '<br />'+crossref+'<a href="http://xueshu.baidu.com/s?wd='+journalTitle+'&rsv_bp=0&tn=SE_baiduxueshu_c1gjeupa&rsv_spt=3&ie=utf-8&f=8&rsv_sug2=0&sc_f_para=sc_tasktype%3D{firstSimpleSearch&qq-pf-to=pcqq.c2c" target="_bank">百度学术<i class="articleFont icon-fenxiang"></i></a>';
	                    }
	                    html += '<tr><td class="td1" valign="top">'+supLiterNum+'</td>'+supLiter+ref+'</tr>';
	                }
                }

                $('.article-pc .box-tan .box-content').html(html);
                show($('.article-pc .box-tan'),$(this));
            }else{
                var _this = $(this);
                var olLen=$("#References .References-wrap .reference-tab tr");
                for(var i=0;i<olLen.length;i++){
                    var dataHref=$(this).find("a").attr("data-href").substring(1);
                    if(olLen.eq(i).attr("id")==dataHref){
                        var olSpan=olLen.eq(i).find(".td1").text();
                        var olText=olLen.eq(i).find(".td2").prop('outerHTML');
                        text = '<table><tr><td class="td1" valign="top">'+olSpan+'</td>'+olText+'</tr></table>';
                    }
                }
                if(text!=""){
                    $('.article-pc .box-tan .box-content').html(text);
                    show($('.article-pc .box-tan'),_this);
                }
            }

        })
    });
    
    $(".article-app .summary span.xref").each(function(){		//手机的
        var text='';
        $(this).click(function(event){
            event.preventDefault();
            var _this = $(this);
            var reftype = $(this).find("a").attr("ref-type");
            console.log($(this).html());
           
          
            var olLen=$("#References .References-wrap .reference-tab tr");
            if (reftype=="fn")
            {
            	
                olLen=$("#footNote .References-wrap .reference-tab tr");
            }
            for(var i=0;i<olLen.length;i++){
                var dataHref=$(this).find("a").attr("data-href").substring(1);
                if(olLen.eq(i).attr("id")==dataHref){
                    var olSpan=olLen.eq(i).find(".td1").text();
                    var olText=olLen.eq(i).find(".td2").prop('outerHTML');
                    text = '<table><tr><td class="td1" valign="top">'+olSpan+'</td>'+olText+'</tr></table>';
                }
            }
            if(text!=""){
                $('.article-app .box .box-content').html(text);
                show2($('.article-app .box'),_this);
            }
        })
    });
    $(".article-app .FullText-all span.xref").each(function(){		//手机的
        var text='';
        $(this).click(function(event){
            event.preventDefault();
            var _this = $(this);
            var reftype = $(this).find("a").attr("ref-type");
            console.log($(this).html());
           
          
            var olLen=$("#References .References-wrap .reference-tab tr");
            if (reftype=="fn")
            {
            	
                olLen=$("#footNote .References-wrap .reference-tab tr");
            }
            for(var i=0;i<olLen.length;i++){
                var dataHref=$(this).find("a").attr("data-href").substring(1);
                if(olLen.eq(i).attr("id")==dataHref){
                    var olSpan=olLen.eq(i).find(".td1").text();
                    var olText=olLen.eq(i).find(".td2").prop('outerHTML');
                    text = '<table><tr><td class="td1" valign="top">'+olSpan+'</td>'+olText+'</tr></table>';
                }
            }
            if(text!=""){
                $('.article-app .box .box-content').html(text);
                show2($('.article-app .box'),_this);
            }
        })
    });

    // 点文字fig对应的图片弹出来
    $("#FullText>p .xref").click(function(){
        var _thisHref=$(this).find("a").attr("data-href").substring(1);
        var fig=$("#FullText ._figclass");
        for(var i=0;i<fig.length;i++){
            if(fig.eq(i).find("a img").attr("id")==_thisHref){
                fig.eq(i).find(".figure_title>a").click();
            }
        }
    });

    //点表格文字弹出表格
    $("#FullText span.xref").click(function(){
        var _thisHref=$(this).find("a").attr("data-href").substring(1);
        var bigLi=$(".show-table .piclist li");
        for(var i=0;i<bigLi.length;i++){
            if(bigLi.eq(i).find(".article_table_fullText").attr("ref")==_thisHref){
                $(".show-table").show();
                $(".piclist li").eq(i).show().siblings().hide();
                $("#picsmall li").eq(i).addClass("current").siblings().removeClass("current");

            }
        }
        $(".show-table .piclist li").each(function(){
            for(var i=0;i<$(this).length;i++){
               // $(this).eq(i).find(".table_new").css({"height":$(this).eq(i).find(".article_table_fullText").height()})
            	 $(this).eq(i).find(".table_new").css({"height":$(window).height()})
            	
            }
        });
    });
    // 在表格中加上一个按钮，点击弹出表格
    $("#FullText>.table_new").each(function(){
        $(this).find(".table-csv-right").attr({"data-href":$(this).find(".article_table_fullText").attr("ref")});
    });
    $("#FullText>.table_new .table-csv-right").click(function(){
        var _thisHref=$(this).attr("data-href");
        var bigLi=$(".show-table .piclist li");
        for(var i=0;i<bigLi.length;i++){
            if(bigLi.eq(i).find(".article_table_fullText").attr("ref")==_thisHref){
                $(".show-table").show();
                $(".piclist li").eq(i).show().siblings().hide();
                $("#picsmall li").eq(i).addClass("current").siblings().removeClass("current");

            }
        }
        $(".show-table .piclist li").each(function(){
            for(var i=0;i<$(this).length;i++){
                $(this).eq(i).find(".table_new").css({"height":$(this).eq(i).find(".article_table_fullText").height()})
            }
        });
    });
    $(".new-back").click(function () {
        $(".show-table").hide();
    });




    //表格
    var picList = $('#picsmall li').length;                  
    var picSmallHeigth = $('#picsmall li').height();       
    var picLength = picList*picSmallHeigth;                  
    var index=0;
    var length=$(".piclist li").length;                      
    var i=1;
    $('#picsmall').css('height',picLength);
    function showImg(i){
        $(".piclist li").eq(i).stop(true,true).show(0).siblings("li").hide();
        $("#picsmall li").eq(i).addClass("current").siblings().removeClass("current");
        $(".show-table .piclist li").eq(i).find(".table_new").css({"height":$(".show-table .piclist li").eq(i).find(".article_table_fullText").height()})
    }

    function slideNext(){
        var newIndex=$("#picsmall li.current").index();
        showImg(newIndex+1);
        if(newIndex+1>=4){
            $("#picsmall").animate({ "top": "-=70px" },0);
        }
        if(newIndex+1>length-1){
            showImg(0);
            $("#picsmall").animate({ "top": "0" },0);
        }
    }

    function slidePrev(){
        var prevIndex=$("#picsmall li.current").index();
        showImg(prevIndex-1);
        if((prevIndex-1)==-1){
            var n=-((length-4)*70)
            console.log(n)
            $("#picsmall").animate({ "top": n },0);
        }
        if(prevIndex-1==3 || prevIndex-1==2){
            $("#picsmall").animate({ "top": "0" },0);
        }
    }
    $("#big_play_next,#play_next").click(function(){
        slideNext();

        return false;
    });
    $("#big_play_prev,#play_prev").click(function(){
        slidePrev();

        return false;
    });
    $("#picsmall li").click(function(i){
        index  =  $("#picsmall li").index(this);
        showImg(index);
        return false;
    });

    $(".show-tu").click(function(){
        if($("#imgShow").css("display")=="none"){
            $("#imgShow").show();
        }
        $(".atlas img").click();
    });
    $(".show-biao").click(function(){
        if($(".show-table").css("display")=="none"){
            $(".show-table").show();
        }
        $(".piclist li").eq(0).stop(true,true).show(0).siblings("li").hide();
        $("#picsmall li").eq(0).addClass("current").siblings().removeClass("current");
        $(".show-table .piclist li").find(".table_new").css({"height":$(".show-table .piclist li").find(".article_table_fullText").height()})
    });
});









